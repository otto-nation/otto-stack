name: Validation

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
    paths:
      - "docs-site/**"
      - "*.md"
      - ".github/.commitlintrc.json"
      - ".github/.release-please-config.json"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GOTOOLCHAIN: local
  CGO_ENABLED: 0

jobs:
  validation:
    name: Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Load configuration
        id: config
        uses: ./.github/actions/load-config

      - name: Setup environment
        uses: ./.github/actions/setup-environment
        with:
          install-task: "true"
          install-tools: "true"

      - name: Validate conventional commits
        if: github.event_name == 'pull_request'
        uses: wagoid/commitlint-github-action@v5
        with:
          configFile: .github/.commitlintrc.js

      - name: Setup Hugo for validation
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ steps.config.outputs.hugo-version }}
          extended: true

      - name: Validate documentation
        run: task validate:docs

      - name: Verify generated files
        run: |
          task generate
          
          # Check for code changes (excluding docs)
          CODE_CHANGES=$(git diff --name-only | grep -v 'docs-site/content' || true)
          if [ -n "$CODE_CHANGES" ]; then
            echo "âŒ Generated code files are out of date"
            echo "Run 'task generate' and commit the changes"
            echo "$CODE_CHANGES"
            exit 1
          fi
          
          # Check docs changes (excluding lastmod lines)
          DOCS_CHANGES=$(git diff docs-site/content/ | grep -v '^[+-]lastmod:' | grep '^[+-]' | grep -v '^+++\|^---' || true)
          if [ -n "$DOCS_CHANGES" ]; then
            echo "âŒ Generated documentation is out of date"
            echo "Run 'task generate' and commit the changes"
            git diff docs-site/content/
            exit 1
          fi
          
          echo "âœ… Generated files are up to date"

      - name: Check for broken links
        uses: tcort/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: "yes"
          use-verbose-mode: "no"
          config-file: ".github/markdown-link-check.json"
          folder-path: "docs-site/content"
        timeout-minutes: 5
        continue-on-error: true

      - name: Validation summary
        if: always()
        run: |
          echo "## ðŸ“‹ Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Configuration**: Files validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Documentation**: Checked for issues" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Hugo**: Site configuration and content validated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Code Quality**: Basic checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ See individual steps above for detailed results." >> $GITHUB_STEP_SUMMARY
