name: kafka-broker
description: Apache Kafka broker for event streaming and messaging
service_type: container
shareable: true

environment:
  KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_HOST:-localhost}:${KAFKA_PORT:-9092}
  KAFKA_HOST: ${KAFKA_HOST:-localhost}
  KAFKA_PORT: ${KAFKA_PORT:-9092}
  KAFKA_URL: kafka://${KAFKA_HOST:-localhost}:${KAFKA_PORT:-9092}

container:
  image: confluentinc/cp-kafka:latest
  ports:
    - external: "9099"
      internal: "9099"
      protocol: tcp
  restart: unless-stopped
  memory_limit: 1024m
  health_check:
    test:
      [
        "CMD",
        "kafka-broker-api-versions",
        "--bootstrap-server",
        "localhost:9099",
      ]
    interval: 30s
    timeout: 10s
    retries: 3

service:
  dependencies:
    required:
      - zookeeper
    provides:
      - messaging
      - streaming

init_service:
  enabled: true
  mode: container
  image: confluentinc/cp-kafka:latest
  scripts:
    - content: |
        echo "Waiting for Kafka broker to be ready..."
        until kafka-broker-api-versions --bootstrap-server kafka-broker:9099 >/dev/null 2>&1; do
          echo "Kafka is unavailable - sleeping"
          sleep 2
        done
        echo "Kafka is ready!"

        # Create topics if specified
        {{range .topics}}
        echo "Creating topic: {{.name}}"
        kafka-topics --create \
          --bootstrap-server kafka-broker:9099 \
          --topic {{.name}} \
          --partitions {{.partitions}} \
          --replication-factor {{.replication_factor}} \
          --if-not-exists
        {{end}}
  wait_for_service: true
  timeout: "60s"

configuration_schema:
  type: object
  properties:
    topics:
      type: array
      description: Kafka topics to create on startup
      items:
        type: object
        properties:
          name:
            type: string
            description: Topic name
          partitions:
            type: integer
            default: 3
            description: Number of partitions
          replication_factor:
            type: integer
            default: 1
            description: Replication factor
        required: ["name"]

documentation:
  usage_notes: Kafka broker handles message storage and delivery. Requires Zookeeper for coordination. Supports automatic topic creation via init service.
  links:
    - https://kafka.apache.org/documentation/
    - https://docs.spring.io/spring-kafka/docs/current/reference/html/
  use_cases:
    - Event-driven microservices architecture
    - Real-time data streaming and processing
    - Message queuing between services
    - Data pipeline and ETL processes
