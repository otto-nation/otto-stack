name: mysql
description: MySQL relational database for persistent data storage
service_type: container
shareable: true

environment:
  DATABASE_URL: mysql://${MYSQL_USER:-root}:${MYSQL_PASSWORD:-password}@${MYSQL_HOST:-localhost}:${MYSQL_PORT:-3306}/${MYSQL_DATABASE:-local_dev}
  MYSQL_DATABASE: ${MYSQL_DATABASE:-local_dev}
  MYSQL_HOST: ${MYSQL_HOST:-localhost}
  MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
  MYSQL_PORT: ${MYSQL_PORT:-3306}
  MYSQL_URL: mysql://${MYSQL_USER:-root}:${MYSQL_PASSWORD:-password}@${MYSQL_HOST:-localhost}:${MYSQL_PORT:-3306}/${MYSQL_DATABASE:-local_dev}
  MYSQL_USER: ${MYSQL_USER:-root}

container:
  image: mysql:8.0
  ports:
    - external: "3306"
      internal: "3306"
      protocol: tcp
  environment:
    MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD:-password}
    MYSQL_DATABASE: ${MYSQL_DATABASE:-local_dev}
  restart: unless-stopped
  memory_limit: 512m
  health_check:
    test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
    interval: 30s
    timeout: 10s
    retries: 3

service:
  connection:
    type: cli
    default_port: 3306
    default_user: root
    client: mysql
    host_flag: -h
    port_flag: -P
    user_flag: -u
  dependencies:
    conflicts:
      - postgres
    provides:
      - database
      - sql
  management:
    connect:
      type: command
      command: ["mysql"]
      args:
        default: ["-h", "localhost", "-P", "3306", "-u", "root", "-p"]

init_service:
  enabled: true
  mode: container
  image: mysql:8.0
  scripts:
    - content: |
        echo "Waiting for MySQL to be ready..."
        until mysqladmin ping -h ${SERVICE_NAME} --silent; do
          echo "MySQL is unavailable - sleeping"
          sleep 2
        done
        echo "MySQL is ready!"
    - content: |
        -- Create additional databases if specified
        {{range .databases}}
        CREATE DATABASE IF NOT EXISTS {{.name}};
        {{end}}

        -- Create users if specified
        {{range .users}}
        CREATE USER IF NOT EXISTS '{{.name}}'@'%' IDENTIFIED BY '{{.password}}';
        GRANT ALL PRIVILEGES ON {{.database}}.* TO '{{.name}}'@'%';
        {{end}}
        FLUSH PRIVILEGES;
  environment:
    MYSQL_PWD: "${MYSQL_PASSWORD:-password}"
  wait_for_service: true
  timeout: "60s"

configuration_schema:
  type: object
  properties:
    database:
      type: string
      default: "local_dev"
      description: Default database name
    password:
      type: string
      default: "password"
      description: Root password
    user:
      type: string
      default: "root"
      description: Database user
    databases:
      type: array
      description: Additional databases to create
      items:
        type: object
        properties:
          name:
            type: string
    users:
      type: array
      description: Additional users to create
      items:
        type: object
        properties:
          name:
            type: string
          password:
            type: string
          database:
            type: string

documentation:
  usage_notes: MySQL database for relational data storage. Alternative to PostgreSQL. Supports automatic database and user creation via init service.
  links:
    - https://dev.mysql.com/doc/
  use_cases:
    - Primary application database
    - Transactional data storage
    - Relational data modeling
