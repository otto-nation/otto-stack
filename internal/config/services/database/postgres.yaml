name: postgres
description: PostgreSQL relational database for persistent data storage
service_type: container

service:
  characteristics:
    - stateful
    - slow_start
    - graceful_stop
  connection:
    type: cli
    default_port: 5432
    default_user: postgres
    client: psql
    host_flag: -h
    port_flag: -p
    user_flag: -U
    database_flag: -d
  dependencies:
    conflicts:
      - mysql
    provides:
      - database
      - sql
  management:
    connect:
      type: command
      command: ["psql"]
      args:
        default: ["-h", "localhost", "-p", "5432", "-U", "postgres"]

environment:
  DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@${POSTGRES_HOST:-localhost}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-local_dev}
  PGHOST: ${POSTGRES_HOST:-localhost}
  POSTGRES_DB: ${POSTGRES_DB:-local_dev}
  POSTGRES_HOST: ${POSTGRES_HOST:-localhost}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
  POSTGRES_PORT: ${POSTGRES_PORT:-5432}
  POSTGRES_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@${POSTGRES_HOST:-localhost}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-local_dev}
  POSTGRES_USER: ${POSTGRES_USER:-postgres}
  SERVICE_ENDPOINT_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-password}@${POSTGRES_HOST:-localhost}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-local_dev}

container:
  image: postgres:15
  ports:
    - external: "${POSTGRES_PORT:-5432}"
      internal: "5432"
      protocol: tcp
  environment:
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    POSTGRES_DB: ${POSTGRES_DB:-local_dev}
    POSTGRES_USER: ${POSTGRES_USER:-postgres}
  restart: unless-stopped
  memory_limit: 512m
  command:
    - postgres
    - -c
    - shared_preload_libraries=pg_stat_statements
    - -c
    - pg_stat_statements.track=all
    - -c
    - max_connections=200
    - -c
    - log_statement=all
    - -c
    - log_destination=stderr
    - -c
    - log_min_duration_statement=100ms
  health_check:
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
    interval: 30s
    timeout: 10s
    retries: 3

init_container:
  enabled: true
  image: postgres:15-alpine
  scripts:
    - type: shell
      content: |
        echo "Waiting for PostgreSQL to be ready..."
        until pg_isready -h ${SERVICE_NAME} -p 5432 -U postgres; do
          echo "PostgreSQL is unavailable - sleeping"
          sleep 2
        done
        echo "PostgreSQL is ready!"
    - type: sql
      content: |
        -- Create additional databases if specified
        {{range .databases}}
        CREATE DATABASE IF NOT EXISTS {{.name}};
        {{end}}
        
        -- Create schemas if specified  
        {{range .schemas}}
        CREATE SCHEMA IF NOT EXISTS {{.name}};
        {{end}}
  environment:
    PGPASSWORD: "${POSTGRES_PASSWORD:-password}"
  wait_for_service: true
  timeout: "60s"

configuration_schema:
  type: object
  properties:
    database:
      type: string
      default: "local_dev"
      description: Default database name
    password:
      type: string
      default: "password"
      description: Database password
    user:
      type: string
      default: "postgres"
      description: Database user

documentation:
  examples:
    - psql -h localhost -U postgres -c "SELECT version();"
    - spring.datasource.url=jdbc:postgresql://localhost:5432/my_app_dev
  usage_notes: Ideal for structured data and transactional workloads. Use overrides to set custom database/user.
  links:
    - https://www.postgresql.org/docs/
    - https://spring.io/projects/spring-data-jpa
  use_cases:
    - Primary application database
    - Transactional data storage
    - Relational data modeling
    - ACID compliance requirements
