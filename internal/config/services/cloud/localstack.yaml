name: localstack
description: LocalStack core AWS service emulator
hidden: true
service_type: container
shareable: true

service:
  characteristics:
    - network_service
  dependencies:
    provides:
      - aws-emulation
      - cloud-core
  connection:
    default_port: 4566

environment:
  AWS_ACCESS_KEY_ID: test
  AWS_DEFAULT_REGION: us-east-1
  AWS_ENDPOINT_URL: http://${LOCALSTACK_HOST:-localhost}:${LOCALSTACK_PORT:-4566}
  AWS_SECRET_ACCESS_KEY: test
  LOCALSTACK_HOST: ${LOCALSTACK_HOST:-localhost}
  LOCALSTACK_PORT: ${LOCALSTACK_PORT:-4566}
  LOCALSTACK_URL: http://${LOCALSTACK_HOST:-localhost}:${LOCALSTACK_PORT:-4566}
  SERVICES: ${LOCALSTACK_SERVICES:-}

container:
  image: localstack/localstack:latest
  ports:
    - external: "${LOCALSTACK_PORT:-4566}"
      internal: "4566"
      protocol: tcp
  restart: unless-stopped
  memory_limit: 512m
  health_check:
    test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
    interval: 15s
    timeout: 10s
    retries: 10
    start_period: 60s

init_service:
  enabled: true
  mode: local
  image: amazon/aws-cli:latest
  environment:
    AWS_ACCESS_KEY_ID: test
    AWS_SECRET_ACCESS_KEY: test
    AWS_DEFAULT_REGION: us-east-1
    AWS_ENDPOINT_URL: http://localstack:4566
  scripts:
    - content: |
        # Setup function
        awscli() {
          docker run --rm --network=$DOCKER_NETWORK -e AWS_ACCESS_KEY_ID=test -e AWS_SECRET_ACCESS_KEY=test -e AWS_DEFAULT_REGION=us-east-1 $DOCKER_IMAGE "$@" --endpoint-url=http://localstack:4566
        }

        # Setup environment variables
        export AWS_ACCOUNT_ID=000000000000

        # Wait for LocalStack to be ready
        echo "Waiting for LocalStack to be ready..."
        for i in {1..30}; do
          if awscli sts get-caller-identity >/dev/null 2>&1; then
            echo "LocalStack is ready!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done

        # Create SNS topics
        {{range .topics}}
        awscli sns create-topic --name {{.name}}
        {{end}}

        # Create SQS queues
        {{range .queues}}
        awscli sqs create-queue --queue-name {{.name}}

        # Create Subscription
        subscriptionArn=$(awscli sns subscribe \
          --topic-arn arn:aws:sns:${AWS_DEFAULT_REGION}:${AWS_ACCOUNT_ID}:{{.subscription.topic}} \
          --protocol sqs \
          --notification-endpoint arn:aws:sqs:${AWS_DEFAULT_REGION}:${AWS_ACCOUNT_ID}:{{.name}} \
          | jq -r '.SubscriptionArn')

        # Set Subscription Attributes
        awscli sns set-subscription-attributes \
          --subscription-arn $subscriptionArn \
          --attribute-name RawMessageDelivery \
          --attribute-value {{.subscription.rawMessageDelivery}}
        {{end}}

        # Create S3 buckets
        {{range .buckets}}
        awscli s3 mb s3://{{.name}}
        {{end}}
  container:
    depends_on_service: true
    timeout: "30s"

documentation:
  usage_notes: Core LocalStack service providing AWS API emulation for local development. Web dashboard requires LocalStack Pro license.
  links:
    - https://docs.localstack.cloud/
  use_cases:
    - AWS service emulation for local development
    - Cloud service testing without AWS costs
    - Offline development environment
